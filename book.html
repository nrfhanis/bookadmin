<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartBook | Admin Hub Premium</title>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --bg-dark: #050805;
            --card-dark: #0D140D;
            --emerald-bright: #2DFFB4;
            --emerald-glow: rgba(45, 255, 180, 0.3);
            --dark-green-box: #062419;
            --white: #F8FAFC;
            --text-muted: #64748b;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: radial-gradient(circle at top right, #0D140D 0%, #050805 100%);
            background-attachment: fixed;
            color: var(--white);
            font-family: 'Plus Jakarta Sans', sans-serif;
            min-height: 100vh;
        }

        .app { display: flex; padding: 30px; gap: 30px; min-height: 100vh; }

        .sidebar { 
            width: 300px; 
            background: rgba(13, 20, 13, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(45, 255, 180, 0.15);
            border-radius: 24px;
            padding: 40px 20px; 
            display: flex; flex-direction: column; 
            height: calc(100vh - 60px);
            position: sticky; top: 30px;
        }

        .brand { 
            font-family: 'Playfair Display', serif;
            font-size: 24px; font-weight: 800; 
            color: var(--emerald-bright);
            background: var(--dark-green-box);
            margin-bottom: 50px; text-align: center;
            text-transform: uppercase; letter-spacing: 4px;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(45, 255, 180, 0.2);
        }

        .nav a { 
            display: flex; align-items: center; gap: 15px; text-decoration: none; 
            color: var(--text-muted); padding: 16px 20px; border-radius: 12px; 
            transition: all 0.4s ease; 
            margin-bottom: 8px; cursor: pointer; font-weight: 600;
        }

        .nav a:hover { color: var(--emerald-bright); background: rgba(45, 255, 180, 0.05); }
        .nav a.active { background: var(--emerald-bright); color: #050805; box-shadow: 0 8px 20px var(--emerald-glow); }
        .nav a.logout-btn:hover { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

        .main { flex: 1; display: flex; flex-direction: column; }
        .header { text-align: center; margin-bottom: 50px; }
        .header h1 { 
            font-family: 'Playfair Display', serif; 
            font-size: 64px; 
            color: var(--emerald-bright); 
            text-shadow: 0 0 20px var(--emerald-glow);
        }
        .header p { color: var(--text-muted); font-size: 14px; letter-spacing: 3px; text-transform: uppercase; }

        .card { 
            background: var(--card-dark);
            padding: 40px; border-radius: 24px; 
            border: 1px solid rgba(45, 255, 180, 0.15); 
            margin-bottom: 30px;
        }

        .card h3 { 
            margin-bottom: 30px; color: var(--emerald-bright); 
            font-family: 'Playfair Display', serif; font-size: 24px;
            border-bottom: 1px solid rgba(45, 255, 180, 0.1);
            padding-bottom: 12px;
        }

        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 30px; }
        .stat-box {
            background: rgba(255,255,255,0.02);
            padding: 22px 15px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid rgba(45, 255, 180, 0.1);
        }
        .stat-box small { color: var(--text-muted); font-size: 10px; text-transform: uppercase; display: block; margin-bottom: 10px; }
        .stat-box h2 { font-size: 32px; color: var(--emerald-bright); }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; color: var(--emerald-bright); font-size: 11px; text-transform: uppercase; letter-spacing: 2px; }
        td { padding: 20px 15px; border-bottom: 1px solid rgba(255,255,255,0.03); }

        .btn { 
            padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; 
            font-weight: 700; font-size: 10px; text-transform: uppercase; 
            transition: 0.3s;
        }
        .btn-approve { background: var(--emerald-bright); color: #050805; margin-right: 5px; }
        .btn-reject { background: transparent; color: var(--emerald-bright); border: 1px solid var(--emerald-bright); }
        .btn-delete { background: #1e293b; color: #64748b; }
        .btn-excel { background: #22c55e; color: white; padding: 15px 25px; font-size: 14px; display: inline-flex; align-items: center; gap: 10px; margin-top: 10px; }
        .btn-excel:hover { background: #16a34a; transform: translateY(-2px); }

        .status-badge { font-weight: 800; font-size: 10px; padding: 6px 16px; border-radius: 20px; background: rgba(45, 255, 180, 0.05); border: 1px solid rgba(45, 255, 180, 0.15); }
        
        #calendar { background: #F8FAFC; padding: 20px; border-radius: 20px; color: #1e293b; border: 1px solid var(--emerald-bright); }

        .setting-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px; background: rgba(255,255,255,0.03); border-radius: 15px; margin-bottom: 15px;
        }
        .setting-info h4 { color: var(--white); margin-bottom: 5px; }
        .setting-info p { color: var(--text-muted); font-size: 13px; }

        @media (max-width: 1024px) {
            .app { flex-direction: column; }
            .sidebar { width: 100%; height: auto; position: static; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

<div class="app">
    <aside class="sidebar">
        <div class="brand">SMART-BOOK</div>
        <nav class="nav">
            <a id="nav-dashboard" onclick="showSection('dashboard')"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
            <a id="nav-new" class="active" onclick="showSection('new')"><i class="fa-solid fa-bell"></i> Requests</a>
            <a id="nav-history" onclick="showSection('history')"><i class="fa-solid fa-clock-rotate-left"></i> History</a>
            <a id="nav-calendar" onclick="showSection('calendar')"><i class="fa-solid fa-calendar-days"></i> Calendar</a>
            <a id="nav-setting" onclick="showSection('setting')"><i class="fa-solid fa-gears"></i> Setting</a>
            <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <a onclick="logout()" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
            </div>
        </nav>
    </aside>

    <main class="main">
        <div class="header">
            <h1>Admin Hub</h1>
            <p>Futuristic Management Hub</p>
        </div>

        <div id="section-dashboard" class="card" style="display:none;">
            <h3>Internal Analytics</h3>
            <div class="stats-grid">
                <div class="stat-box"><small>Total</small><h2 id="stat-total">0</h2></div>
                <div class="stat-box"><small>Pending</small><h2 id="stat-pending" style="color:var(--warning)">0</h2></div>
                <div class="stat-box"><small>Accepted</small><h2 id="stat-accepted">0</h2></div>
                <div class="stat-box"><small>Rejected</small><h2 id="stat-rejected" style="color:var(--danger)">0</h2></div>
                <div class="stat-box"><small>Most Popular</small><h2 id="stat-popular" style="font-size: 14px;">-</h2></div>
            </div>
            <div style="height: 350px;"><canvas id="bookingChart"></canvas></div>
        </div>

        <div id="section-new" class="card">
            <h3>Incoming Requests</h3>
            <div style="overflow-x: auto;">
                <table>
                    <thead><tr><th>Equipment</th><th>Date</th><th>Time</th><th>Status</th><th>Control</th></tr></thead>
                    <tbody id="table-new"></tbody>
                </table>
            </div>
        </div>

        <div id="section-history" class="card" style="display:none;">
            <h3>System Archives</h3>
            <div style="overflow-x: auto;">
                <table>
                    <thead><tr><th>Equipment</th><th>Date</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody id="table-history"></tbody>
                </table>
            </div>
        </div>

        <div id="section-calendar" class="card" style="display:none;">
            <h3>Booking Calendar</h3>
            <div id="calendar"></div>
        </div>

        <div id="section-setting" class="card" style="display:none;">
            <h3>System Settings</h3>
            
            <div class="setting-item">
                <div class="setting-info">
                    <h4>Export Data</h4>
                    <p>Download The Bookings Record in Excel (.xlsv)</p>
                </div>
                <button class="btn btn-excel" onclick="downloadExcel()">
                    <i class="fa-solid fa-file-excel"></i> Download Excel
                </button>
            </div>

            <div class="setting-item">
                <div class="setting-info">
                    <h4>System Maintenance</h4>
                    <p>Database status and Firebase connections</p>
                </div>
                <span class="status-badge" style="color:var(--emerald-bright)">Active / Online</span>
            </div>

            <div class="setting-item">
                <div class="setting-info">
                    <h4>Version Control</h4>
                    <p>SmartBook Admin Portal V2.0 (Premium Hub)</p>
                </div>
                <small style="color:var(--text-muted)">Last Update: Jan 2026</small>
            </div>
        </div>
    </main>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBtkIJ0hZD6mXiC7fE6sYDvpqohSsn0c7s",
        authDomain: "smartbook-f1315.firebaseapp.com",
        projectId: "smartbook-f1315",
        storageBucket: "smartbook-f1315.firebasestorage.app",
        messagingSenderId: "778504441106",
        appId: "1:778504441106:web:704d93dca91fda099c77cb"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let myChart;
    let calendar;
    let allDataForExcel = [];

    auth.onAuthStateChanged(user => {
        if (!user) {
            window.location.href = "index.html";
        } else {
            loadData();
        }
    });

    function logout() {
        if(confirm("Are you sure you want to log out?")) {
            auth.signOut().then(() => window.location.href = "index.html");
        }
    }

    function showSection(section) {
        const sections = ['new', 'history', 'dashboard', 'calendar', 'setting'];
        sections.forEach(s => {
            document.getElementById(`section-${s}`).style.display = section === s ? 'block' : 'none';
            document.getElementById(`nav-${s}`).classList.toggle('active', section === s);
        });
        if(section === 'calendar' && calendar) calendar.render();
    }

    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
            events: []
        });
        calendar.render();
    });

    async function loadData() {
        db.collectionGroup("bookings").onSnapshot(async (snapshot) => {
            const tableNew = document.getElementById("table-new");
            const tableHistory = document.getElementById("table-history");
            tableNew.innerHTML = ""; 
            tableHistory.innerHTML = "";
            allDataForExcel = [];
            
            let stats = { total: 0, pending: 0, accepted: 0, rejected: 0, items: {} };
            let calEvents = [];

            for (const docSnap of snapshot.docs) {
                const data = docSnap.data();
                const parentPath = docSnap.ref.path;
                let equipName = "Peralatan";

                try {
                    const userRef = docSnap.ref.parent.parent; 
                    const userDoc = await userRef.get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        equipName = userData.display_name || (userData.email ? userData.email.split('@')[0].toUpperCase() : "DEVICE");
                    }
                } catch (e) { console.error(e); }

                let dStr = "-", tStr = "-";
                if(data.time) {
                    const dateObj = data.time.toDate();
                    dStr = dateObj.toLocaleDateString('en-GB');
                    tStr = dateObj.getHours().toString().padStart(2,'0') + ':' + dateObj.getMinutes().toString().padStart(2,'0');
                }

                stats.total++;
                const status = data.status || 'Pending';

                // Simpan data untuk Excel
                allDataForExcel.push({
                    Peralatan: equipName,
                    Tarikh: dStr,
                    Masa: tStr,
                    Status: status
                });

                if(status === 'Pending') stats.pending++;
                else if(status === 'Approved') {
                    stats.accepted++;
                    stats.items[equipName] = (stats.items[equipName] || 0) + 1;
                    if(data.time) calEvents.push({ title: equipName, start: data.time.toDate(), color: '#2DFFB4' });
                }
                else if(status === 'Rejected') stats.rejected++;

                const userCell = `<div class="user-box"><strong>${equipName}</strong></div>`;
                let statusColor = (status === 'Approved') ? "var(--emerald-bright)" : (status === 'Rejected' ? "var(--danger)" : "var(--warning)");

                if (status === "Approved" || status === "Rejected") {
                    tableHistory.innerHTML += `<tr><td>${userCell}</td><td>${dStr}</td><td><span class="status-badge" style="color:${statusColor}">${status}</span></td><td><button class="btn btn-delete" onclick="deleteBooking('${parentPath}')">Delete</button></td></tr>`;
                } else {
                    tableNew.innerHTML += `<tr><td>${userCell}</td><td>${dStr}</td><td>${tStr}</td><td><span class="status-badge" style="color:${statusColor}">${status}</span></td><td><button class="btn btn-approve" onclick="updateStatus('${parentPath}', 'Approved')">Accept</button><button class="btn btn-reject" onclick="updateStatus('${parentPath}', 'Rejected')">Reject</button></td></tr>`;
                }
            }
            updateDashboard(stats);
            calendar.removeAllEvents();
            calendar.addEventSource(calEvents);
        });
    }

    function downloadExcel() {
        if(allDataForExcel.length === 0) {
            alert("Download all booking records into an Excel file (.xlsx).");
            return;
        }
        const worksheet = XLSX.utils.json_to_sheet(allDataForExcel);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Laporan Tempahan");
        XLSX.writeFile(workbook, "Laporan_SmartBook_Admin.xlsx");
    }

    function updateDashboard(stats) {
        document.getElementById('stat-total').innerText = stats.total;
        document.getElementById('stat-pending').innerText = stats.pending;
        document.getElementById('stat-accepted').innerText = stats.accepted;
        document.getElementById('stat-rejected').innerText = stats.rejected;
        
        let popular = Object.keys(stats.items).reduce((a, b) => stats.items[a] > stats.items[b] ? a : b, "-");
        document.getElementById('stat-popular').innerText = popular;

        const ctx = document.getElementById('bookingChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(stats.items),
                datasets: [{ label: 'Usage', data: Object.values(stats.items), backgroundColor: '#2DFFB4', borderRadius: 5 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    window.updateStatus = function(path, s) {
        db.doc(path).update({ status: s }).catch(err => alert(err.message));
    };

    window.deleteBooking = function(path) {
        if(confirm("Delete This Record?")) {
            db.doc(path).delete().catch(err => alert(err.message));
        }
    };
</script>
</body>
</html>